name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v3

      - name: Configure Git üîß
        run: |
          git config pull.rebase false

      - name: Assemble Build Directory üì¶
        run: |
          mkdir -p build/config build/src build/docs
          cp index.html favicon.svg build/
          cp -r src/. build/src/
          cp -r docs/. build/docs/
          cp config/config.example.js build/config/

      - name: Inject GAS_URL Secret ü§´
        run: |
          echo "window.CONFIG = { GAS_URL: '${{ secrets.GAS_URL }}' };" > build/config/config.local.js
        env:
          GAS_URL: ${{ secrets.GAS_URL }}

      - name: Deploy üöÄ
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: build

  deploy-gas:
    runs-on: ubuntu-latest
    # Only run if commit message contains [deploy-gas] and secrets are configured
    if: contains(github.event.head_commit.message, '[deploy-gas]')
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v3

      - name: Setup Node.js üîß
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Dependencies üì¶
        run: |
          npm install -g @google/clasp
          npm install

      - name: Deploy to Google Apps Script üöÄ
        env:
          CLASP_SCRIPT_ID: ${{ secrets.CLASP_SCRIPT_ID }}
          GAS_SHEET_ID: ${{ secrets.GAS_SHEET_ID }}
          CLASP_ACCESS_TOKEN: ${{ secrets.CLASP_ACCESS_TOKEN }}
          CLASP_REFRESH_TOKEN: ${{ secrets.CLASP_REFRESH_TOKEN }}
          CLASP_CLIENT_ID: ${{ secrets.CLASP_CLIENT_ID }}
          CLASP_CLIENT_SECRET: ${{ secrets.CLASP_CLIENT_SECRET }}
        run: |
          # Check if secrets are set
          if [ -z "$CLASP_SCRIPT_ID" ]; then
            echo "‚ö†Ô∏è CLASP_SCRIPT_ID not set - skipping GAS deployment"
            echo "See docs/AI_AGENT_DEPLOYMENT.md for setup instructions"
            exit 0
          fi
          
          # Run deployment script
          npm run deploy:gas

      - name: Verify Deployment ‚úÖ
        if: success()
        run: |
          echo "‚úì Google Apps Script deployment completed successfully"
          echo "Next steps:"
          echo "1. Verify deployment at https://script.google.com"
          echo "2. Test API endpoints"
          echo "3. Update frontend if needed"
