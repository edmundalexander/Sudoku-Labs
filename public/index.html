<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sudoku Logic Lab</title>
    <!-- Favicon with multiple formats for better browser compatibility -->
    <link
      rel="icon"
      type="image/svg+xml"
      sizes="any"
      href="./favicon.svg?v=2"
    />
    <link
      rel="alternate icon"
      type="image/svg+xml"
      sizes="any"
      href="/Sudoku-Labs/favicon.svg?v=2"
    />
    <link rel="shortcut icon" type="image/svg+xml" href="./favicon.svg?v=2" />
    <link rel="apple-touch-icon" sizes="180x180" href="./favicon.svg?v=2" />
    <!-- Google Material Icons -->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined"
      rel="stylesheet"
    />
    <!-- Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Tailwind CSS (production build) -->
    <link id="tailwind-css" href="./styles.css" rel="stylesheet" />
    <!-- Accessibility overrides (load after main CSS) -->
    <link
      id="accessibility-css"
      href="./styles-accessibility.css"
      rel="stylesheet"
    />
    <script>
      // Fix CSS path for GitHub Pages
      (function () {
        const basePath =
          window.location.hostname === "edmund-alexander.github.io"
            ? "/Sudoku-Labs/"
            : "./";
        const tail = document.getElementById("tailwind-css");
        const acc = document.getElementById("accessibility-css");
        if (tail) {
          tail.href = basePath + "styles.css";
          tail.onerror = function(){ tail.remove(); };
        }
        if (acc) {
          acc.href = basePath + "styles-accessibility.css";
          acc.onerror = function(){ acc.remove(); };
        }
      })();
    </script>
    <!-- React -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <!-- Babel Standalone for in-browser JSX compilation -->

    <!-- Inline shim: define minimal legacy globals if services.js fails to load -->
    <script>
      (function () {
        // Provide a minimal `window.StorageService` stub to avoid runtime crashes
        // Do not declare `var StorageService` here to avoid duplicate-declaration errors
        try {
          if (typeof window !== "undefined") {
            if (!window.StorageService) {
              window.StorageService = {
                isAvailable: function () {
                  return false;
                },
                getUserSession: function () {
                  return null;
                },
                getUserId: function () {
                  return "guest";
                },
                getUnlockedThemes: function () {
                  return ["default"];
                },
                getUnlockedSoundPacks: function () {
                  return ["classic"];
                },
                getActiveTheme: function () {
                  return "default";
                },
                getActiveSoundPack: function () {
                  return "classic";
                },
                isUserAuthenticated: function () {
                  return false;
                },
                saveUserSession: function () {},
                setUserSession: function () {},
                saveUnlockedThemes: function () {},
                saveUnlockedSoundPacks: function () {},
                getGameStats: function () {
                  return {};
                },
                saveGameStats: function () {},
              };
            }
          }
        } catch (err) {
          // ignore shim errors
        }
      })();
    </script>
    <!-- Prevent dark mode flash: Check localStorage and apply dark class ASAP -->
    <script>
      (function () {
        const savedTheme = localStorage.getItem("theme");
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;
        if (savedTheme === "dark" || (!savedTheme && prefersDark)) {
          document.documentElement.classList.add("dark");
        }
      })();
    </script>

    <!-- Cache/version guard: uses deployed ETag (commit) as version so any push forces a fresh load -->
    <script>
      (function () {
        const fetchVersion = async () => {
          try {
            const res = await fetch(window.location.href, {
              method: "HEAD",
              cache: "no-cache",
            });
            const etag = res.headers.get("etag");
            if (etag) return etag.replace(/"/g, "");
          } catch (e) {
            console.warn("Version HEAD fetch failed:", e);
          }
          return "local-dev"; // fallback for offline/local
        };

        const clearCaches = async () => {
          try {
            localStorage.clear();
            sessionStorage.clear();
            if ("caches" in window) {
              const keys = await caches.keys();
              await Promise.all(keys.map((key) => caches.delete(key)));
            }
          } catch (e) {
            console.warn("Cache clear skipped:", e);
          }
        };

        (async () => {
          const appVersion = await fetchVersion();
          const stored = localStorage.getItem("APP_VERSION");
          if (stored !== appVersion) {
            await clearCaches();
            localStorage.setItem("APP_VERSION", appVersion);
            location.reload();
            return;
          }
          window.APP_VERSION = appVersion;
        })();
      })();
    </script>

    <!-- Load configuration from config files -->
    <!-- Priority: config.local.js (dev) → config.production.example.js (GitHub Pages) → defaults -->
    <script>
      // Default config values - will be overwritten by config files if they exist
      window.CONFIG = {
        GAS_URL: null, // Set a default or leave as null
        BASE_PATH: "", // Default to root (no subdirectory)
      };
    </script>

    <!-- Dynamic path resolution for different deployment environments -->
    <script>
      // Detect environment:
      // - GitHub Pages: files are in root (./src/, ./config/)
      // - Local dev served from root: files are also in root (./src/, ./config/)
      // - Local dev served from public/: files are in parent (../src/, ../config/)
      const isGitHubPages = window.location.hostname.includes("github.io");
      const isLocalInPublic = window.location.pathname.includes("/public/");
      const pathPrefix = isLocalInPublic ? "../" : "./";

      // Helper to load scripts with correct path, silently handling failures
      function loadScript(src, attributes = {}) {
        const script = document.createElement("script");
        script.src = pathPrefix + src;
        script.onerror = function () {
          // Silently fail - file is optional
        };
        Object.entries(attributes).forEach(([key, value]) => {
          if (value === true) script.setAttribute(key, "");
          else script.setAttribute(key, value);
        });
        document.currentScript.parentNode.insertBefore(
          script,
          document.currentScript.nextSibling
        );
      }
    </script>

      <!-- Load React app (JSX) only after services have initialized to avoid race conditions -->
      <script>
        (function waitForServicesAndLoadApp() {
          var maxTries = 50;
          var interval = 100; // ms
          var tries = 0;
          function loadAppScripts() {
            loadScript("src/app.jsx", { type: "text/babel", "data-presets": "env,react" });
            loadScript("src/admin.jsx", { type: "text/babel", "data-presets": "env,react" });
            loadScript("src/admin-access.js");
          }
          function check() {
            if (window.StorageService && typeof window.StorageService.getUserSession === "function") {
              loadAppScripts();
              return;
            }
            tries++;
            if (tries > maxTries) {
              // Fallback: still attempt to load app scripts
              loadAppScripts();
              return;
            }
            setTimeout(check, interval);
          }
          check();
        })();
      </script>

    <!-- Configuration files (load conditionally to avoid conflicts) -->
    <script>
      (function () {
        // Attempt to fetch config files before injecting them as <script>
        // This prevents loading HTML 404 pages as JS and causing Unexpected '<'
        async function tryLoad(p) {
          const url = pathPrefix + p;
          try {
            const res = await fetch(url, { method: "GET", cache: "no-cache" });
            if (!res.ok) return;
            const ct = (res.headers.get("content-type") || "").toLowerCase();
            if (ct.includes("text/html")) return; // don't load HTML
            loadScript(p);
          } catch (e) {
            // ignore network errors
          }
        }

        (async function loadConfigs() {
          if (!isGitHubPages) {
            await tryLoad("config/config.local.js");
            await tryLoad("config/admin.local.js");
          } else {
            await tryLoad("config/config.local.js");
          }
        })();
      })();
    </script>

    <!-- Load modular JavaScript files (plain JS, loaded before React components) -->
    <!-- Order matters: constants → utils → sound → services → app -->
    <script>
      loadScript("src/constants.js");
    </script>
    <script>
      loadScript("src/utils.js");
    </script>
    <script>
      loadScript("src/sound.js");
    </script>
    <script>
      loadScript("src/services.js");
    </script>

    <!-- React app and admin console are loaded by the deferred loader above -->
  </body>
</html>
